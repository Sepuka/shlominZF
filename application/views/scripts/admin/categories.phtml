<script language="javascript" type="text/javascript">
Ext.onReady(function() {
	var URLcategoriesAll = '/admin/categoriesView';
	var URLcategoriesEdit = '/admin/categoriesEdit';
	var URLcategoriesAdd = '/admin/categoriesAdd';

	var loadMaskGrid = new Ext.LoadMask(
	    Ext.getBody(),
	    {
	        msg: 'Пожалуйста, подождите. Идет загрузка ...'
	    });

	function folderFormat(f)
	{
		if (f == 0) return 'файл/статья';
        if (f == 1) return 'папка';
	}

	Ext.define('dataModel', {
	   	extend: 'Ext.data.Model',
	   	fields: [
			{name: 'id', type: 'integer'},
			{name: 'sequence', type: 'integer'},
			{name: 'folder', type: 'string'},
			{name: 'parent', type: 'string'},
			{name: 'name', type: 'string'}
		]
	});

	var store = new Ext.data.Store({
		autoLoad: true,
		model: 'dataModel',
        proxy: {
        	url : URLcategoriesAll,
        	type: 'ajax',
        	reader: {
        		type: 'json',
        		root: 'categories',
        		totalProperty: 'total'
			}
		},
		listeners: {
			'update': function(obj, record, operation, opt) {
				loadMaskGrid.show();
				Ext.Ajax.request({
					url: URLcategoriesEdit,
                    method: 'POST',
                    params: {
                        id: record.data['id'],
                        sequence: record.data['sequence'],
                        folder: record.data['folder'],
                        parent: record.data['parent'],
                        name: record.data['name']
                    },
                    success: function(answer) {
                    	loadMaskGrid.hide();
                        //alert(answer.responseText);
                    },
                    failure: function() {
                    	loadMaskGrid.hide();
                        Ext.Msg.alert("Ошибка AJAX", "Server communication failure");
                    }
				});
			}
		}
	});

	var newCategory = Ext.create('Ext.window.Window', {
		title: "Создание новой категории или статьи",
		defaultType: 'textfield',
		width: 400,
        height: 220,
        items: [
            {
                xtype: 'combo',
                fieldLabel: 'категория (родитель)',
                store: <?=$this->categoriesListParent?>,
                width: 380,
                labelWidth: 150,
                itemId: 'parent'
            },{
                fieldLabel: 'подкатегория (потомок)',
                width: 380,
                labelWidth: 150,
                itemId: 'name'
            },{
                xtype: 'combo',
                fieldLabel: 'тип ресурса',
                mode: 'local',
                emptyText: 'файл/статья',
                store: [["0","файл/статья"],["1","папка"]],
                width: 380,
                labelWidth: 150,
                itemId: 'folder'
            },{
                xtype: 'container',
                html: 'Чтобы создать КОРНЕВУЮ директорию, напишите ее имя в поле "подкатегория (потомок)", а поле "категория (родитель)" оставьте пустым. Вы также можете создать категорию-потомок от не существующей категории-родителя, впишите их имена в соответствующие поля и они будут созданы за одно действие.'
            }],
		buttons:
        [
            {
                text: 'Создать новый ресурс',
                handler: function() {
                    newCategory.hide();
                    loadMaskGrid.show();
                    Ext.Ajax.request({
                        url: URLcategoriesAdd,
                        method: 'POST',
                        params: {
                            parent: newCategory.getComponent('parent').getValue(),
                            name: newCategory.getComponent('name').getValue(),
                            folder: newCategory.getComponent('folder').getValue()
                        },
                        success: function(answer) {
                            //alert(answer.responseText);
                            loadMaskGrid.hide();
                            store.load();
                        },
                        failure: function() {
                            Ext.Msg.alert("Ошибка AJAX", "Server communication failure");
                            loadMaskGrid.hide();
                        }
                    })
                }
            },{
                text: 'Закрыть окно',
                handler: function() {
                    newCategory.hide();
                }
            }
        ]
	});

	var menu = new Ext.Panel({
        title: 'Навигация по спискам',
        defaults: {
        	width: 190
        },
        style: {
			textAlign: 'center',
            display: 'block'
		},
        items: [
        	new Ext.form.Label({
                html: 'Список корневых категорий'
        	}),
        	new Ext.form.field.ComboBox({
        		store: <?=$this->categoriesListRoot?>,
        		listeners: {
        			'select': function(field, value, opt) {
        				store.load({
        					url:URLcategoriesAll + '?category=' + field.getValue()
        				});
        			}
        		}
        	}),
			new Ext.form.Label({
                html: 'Показать только тип'
        	}),
        	new Ext.form.field.ComboBox({
        		store: [[0, "статьи"], [1, "папки"]],
        		listeners: {
        			'select': function(field, value, opt) {
        				store.load({
        					url:URLcategoriesAll + '?type=' + field.getValue()
        				});
        			}
        		}
        	})
        ]
	});

	var grid = Ext.create('Ext.grid.Panel', {
		title: 'Редактирование категорий/подкатегорий сайта',
		store: store,
		columns: [
			{
				header: 'id',
				dataIndex: 'id',
				align: 'right',
				width: 80
			},{
				header: 'порядок',
				dataIndex: 'sequence',
				align: 'right',
				width: 80,
				field: 'textfield'
			},{
				header: 'тип данных',
				dataIndex: 'folder',
				renderer: folderFormat,
				align: 'center',
				width: 150,
				field: new Ext.form.field.ComboBox({store:[[0,"файл/статья"],[1,"папка"]]})
			},{
				header: 'родитель',
				dataIndex: 'parent',
				align: 'right',
				width: 150,
				field: 'textfield'
			},{
				header: 'имя',
				dataIndex: 'name',
				align: 'right',
				width: 200,
				field: 'textfield'
			}
		],
		plugins: [
        	Ext.create('Ext.grid.plugin.CellEditing', {
	            clicksToEdit: 1
    	    })
    	],
		dockedItems: [{
	       	xtype: 'pagingtoolbar',
	       	store: store,
	       	dock: 'bottom',
			displayInfo: true
		}],
		buttons: [{
			text: 'создать новый раздел',
			handler: function() {
				newCategory.show();
			}
		},{
			text: 'удалить выбранный раздел'
		},{
			text: 'показать все разделы',
			handler: function() {
                store.load({url:URLcategoriesAll});
            }
		}]
	});

	var viewport = Ext.create('Ext.container.Viewport', {
		layout: 'border',
		items: [{
			region: 'west',
			itemId: 'westMenuPanel',
			width: 200,
			items: menu
		},{
			region: 'center',
			itemId: 'centerMenuPanel',
			items: grid
		}]
	});

	grid.setHeight(viewport.getComponent('centerMenuPanel').getHeight());
	grid.setWidth(viewport.getComponent('centerMenuPanel').getWidth());
});
</script>